#!/bin/sh
# This script will get ran when the user wants to install it.

set -ex

# Package info
USR_NAME="WestleyR"
PKG_NAME="list-files"
BINARY_NAME="lf"
PKG_VERSION="1.3.0"
SHA_256="4752f62a4109182ff258284cdf9f6451cc1b72db5928ceb02579aad9d4f566c4"
MD5_SUM="65f475b3d1083b8643f626be9b4bfb38"
SSUM=""

# Download the package
mkdir -p ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}
wget -O ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/package.tar.gz https://github.com/${USR_NAME}/${PKG_NAME}/archive/v${PKG_VERSION}.tar.gz

# Verify the shasum
if [ -n $SHA_256 ]; then
    checksum_cmd=`command -v sha256sum || (command -v shasum > /dev/null && echo "$(command -v shasum) -a 256") || true`
    if [ -z $checksum_cmd ]; then
        echo "Failed to find sha256sum, or shasum command. Skipping shasum"
    else
        echo "${SHA_256}  ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/package.tar.gz" | $checksum_cmd -c
    fi
fi

# Verify the md5sum
if [ -n $MD5_SUM ]; then
    checksum_cmd=`command -v md5sum || true`
    if [ -z $checksum_cmd ]; then
            echo "Failed to find md5sum command. Skipping md5sum"
    else
        echo "${MD5_SUM}  ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/package.tar.gz" | $checksum_cmd -c
    fi
fi

tar -xf ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/package.tar.gz -C ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}

cd ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/${PKG_NAME}-${PKG_VERSION}

# Build, and install the package in its own directory as a prefix
make install PREFIX=${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/${PKG_NAME}-${PKG_VERSION}

# Link the binary to gpack's bin
ln -f -s ${HOME}/.gpack/installed/${USR_NAME}/${PKG_NAME}/${PKG_NAME}-${PKG_VERSION}/bin/${BINARY_NAME} ${HOME}/.gpack/bin

echo $PKG_VERSION > ../version.gpack

